# 更新日志 (Changelog)

所有该项目的显著更改都将记录在此文件中。

## [2025-12-22] - 多线程下载与在线FAQ

### ✨ 新增功能
- **多任务并发下载**:
  - 解除了强制单线程限制，现在支持**自定义并发数量** (1-10)。
  - 在下载管理界面增加了并发数设置选项，并配合动态风险提示（并发数越高，触发验证码几率越大）。
- **全局验证码熔断机制**:
  - 当任意任务触发验证码时，系统会自动**暂停所有正在运行的任务**，防止连续触发风控。
  - 验证完成后，支持一键恢复所有暂停的任务，无需逐个点击。
- **在线常见问题 (FAQ)**:
  - 新增“常见问题”功能，内容**实时从 GitHub 拉取**，无需更新软件即可获取最新帮助信息。
  - 针对中国大陆网络环境优化，内置了多条 CDN 加速线路 (jsDelivr/GhProxy)，确保加载速度。

### 🐛 问题修复
- **程序退出优化**: 修复了关闭软件时可能出现的 `QThread: Destroyed while thread is still running` 报错，实现了优雅的线程清理与退出逻辑。
- **交互体验**: 优化了验证码弹窗体验，现在弹窗支持非模态显示（不妨碍浏览器操作），并增加了“拖动窗口”提示。

## [2025-12-21] - v1.1.1 版本更新

### ✨ 新增功能与优化
- **UI/UX 优化**:
  - 新增 Bilibili 链接入口，方便用户访问主页。
  - 任务栏图标修复，现在能正确显示应用图标。
  - 安装包现在允许用户自定义安装路径。
- **自动更新增强**:
  - 支持 EXE 环境下的自动更新，下载完成后自动运行安装程序。
  - 主界面新增“检查更新”按钮，并支持强制检查更新。
- **构建系统**:
  - 修复了安装包编译时的多语言翻译缺失问题。
  - 优化了构建脚本，自动清理旧产物并嵌入图标。

## [2025-12-21] - 批量下载运营数据导出

### ✨ 新增功能
- **书籍运营数据导出**:
  - 批量下载时，现在会自动抓取书籍的**运营数据**（状态、在读人数、最新章节、更新时间）。
  - 数据将自动保存为 XLSX 表格文件，方便用户进行数据分析和整理。
  - **智能命名**: 表格文件名将根据当前下载页面的分类自动命名（例如 `都市高武运营数据.xlsx`）。
  - **原生 Excel 支持**: 放弃 CSV 格式，改用原生 XLSX 格式，支持追加写入，避免了编码和分隔符带来的潜在问题。

## [2025-12-21] - 追更模式与增量下载

### ✨ 新增功能
- **全自动追更模式 (增量下载)**:
  - **智能进度识别**: 自动扫描本地已下载的书籍文件夹，精准识别已下载的章节数量。
  - **无缝断点续传**: 下载时自动跳过本地已存在的章节，仅下载线上更新的最新章节。
  - **智能文件追加**: 新下载的章节会自动追加到现有的 TXT/EPUB 文件末尾，无需人工合并，阅读体验连贯。
  - **全面覆盖**: 该功能同时支持**单本下载**和**批量下载**模式。
- **批量下载逻辑升级**:
  - “每本限制章节”选项升级为“每本更新/下载数量”，配合追更模式使用，可轻松实现“为书架上的每本书更新最后10章”的高效操作。

### 🏗️ 代码优化
- **核心逻辑重构**: 深度改造 `downloader.py` 和 `BookFormatter` 策略类，统一了增量更新的底层实现，确保不同格式（TXT/MD/EPUB）均能稳定支持追加写入。
- **章节索引修正**: 修复了追加模式下章节序号可能重置的 Bug，确保追加的章节文件名（如 `051_xxx.txt`）与真实章节顺序保持一致。

## [2025-12-21] - 批量下载优化与标题修复

### ✨ 新增功能
- **批量下载分页支持**: 修复了原创版批量下载仅支持前10本的限制，现在支持多页内容的完整解析与下载。
- **智能标题修正**:
  - 新增 `TitleCorrectionWorker` 后台线程，在批量任务添加到列表后自动获取并修正书籍标题，解决“等待中”任务显示乱码或未知标题的问题。
  - 下载任务列表现支持实时标题更新，从加入队列那一刻起即可看到准确书名。
- **书库加载提示**: 在批量下载选项中增加“向下滚动加载更多”的提示，引导用户正确获取完整列表。

### 🐛 问题修复
- 修复了书库/榜单下载时，任务初始标题显示为乱码的问题。
- 优化了 `DownloadManager` 的信号传递机制，确保任务属性变更能即时反映在 UI 上。
- 增强了标题提取逻辑，支持更多种类的 HTML 标签结构，提高解析成功率。

## [2025-12-20] - 风控对抗与下载管理重构

### ✨ 新增功能
- **下载管理系统重构**:
  - **单线程强制策略**: 为应对平台严格的风控策略，下载任务现强制为单线程执行。
  - **智能任务调度**: 启动新任务时会自动暂停其他运行中的任务；支持用户手动暂停/继续，灵活控制下载优先级。
  - **实时进度反馈**: 批量下载时，任务列表展示每本书的实时下载进度，不再是黑盒操作。
  - **UI 状态逻辑优化**: 按钮状态（开始/继续/暂停/取消）根据任务进度智能切换，操作更符合直觉。
- **反爬虫与稳定性增强**:
  - **全方位文本反混淆**: 升级 `decode_text` 算法，全面覆盖书名、作者名及简介内容，彻底解决“乱码”和“缺字”问题（如“穿 越”修复为“穿越”，“怎敌”修复为“怎敌她动人”）。
  - **强制 UTF-8 编码**: 所有网络请求强制指定 UTF-8 编码，杜绝底层字符集解析错误。
  - **标题自动清洗**: 自动去除书名中的多余空格和混淆字符，确保文件命名规范。
- **界面交互优化**:
  - **选项整合**: 将“保存格式”选择移至下载确认弹窗中，与章节范围、分章设置统一管理，主界面更简洁。
  - **风控提示**: 在下载界面显著位置增加反爬策略提示，透明化单线程限制原因。
- **智能风控对抗系统**: 
  - 全面升级验证码检测逻辑，从源头识别 WAF 拦截页面。
  - 新增**中断恢复机制**：单本/批量下载遇到验证码时自动暂停，支持用户手动验证后无缝断点续传。
- **自定义浏览器导航**: 
  - 彻底重写浏览器历史记录管理堆栈，接管默认导航逻辑。
  - 解决 SPA (单页应用) 路由切换导致的后退按钮失效/变灰问题，提供丝般顺滑的浏览体验。
- **书籍简介自动归档**: 
  - 无论单本还是批量下载，现在都会自动抓取并保存书籍简介。
  - **分章模式**：自动生成 `000_简介.txt/md` 独立文件，方便管理。
  - **整本/EPUB模式**：简介将作为元数据或首章置顶写入，阅读体验更完整。
- **任务控制增强**:
  - 全新上线 **暂停 / 继续 / 停止** 控制面板，让您随时掌控下载进度，应对突发状况。
  - 新增 **下载间隔自定义** 功能：
    - **随机模式 (默认)**: 模拟人类阅读行为，自动使用随机延迟 (0.5s - 1.5s)，降低风控风险。
    - **自定义模式**: 允许用户指定固定间隔 (0.1s - 60s)。*注意：间隔过短极易触发验证码。*

### 🏗️ 代码重构与优化
- **架构解耦**: 
  - 将庞大的 `main.py` 拆分为 `workers.py` (后台任务)、`ui_components.py` (界面组件) 和 `main.py` (主逻辑)，显著提升代码可维护性。
- **策略模式**: 
  - 重构下载核心，引入 `BookFormatter` 策略模式，统一管理 TXT/MD/EPUB 等不同格式的生成逻辑，消除重复代码，便于未来扩展新格式。

### 🐛 问题修复
- 修复了验证码页面被误判为 "VIP章节锁定" 或 "内容为空" 的解析错误。
- 修复了浏览器导航按钮状态（灰色/亮起）与实际页面历史记录不同步的 Bug。
- 修复了部分网络环境下页面自动跳转至手机版 (Mobile) 导致解析失效的问题，新增自动强制切回 PC 版的保护逻辑。
