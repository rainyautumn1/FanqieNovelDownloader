# 更新日志 (Changelog)

所有该项目的显著更改都将记录在此文件中。

## [2025-12-20] - 风控对抗与下载管理重构

### ✨ 新增功能
- **下载管理系统重构**:
  - **单线程强制策略**: 为应对平台严格的风控策略，下载任务现强制为单线程执行。
  - **智能任务调度**: 启动新任务时会自动暂停其他运行中的任务；支持用户手动暂停/继续，灵活控制下载优先级。
  - **实时进度反馈**: 批量下载时，任务列表展示每本书的实时下载进度，不再是黑盒操作。
  - **UI 状态逻辑优化**: 按钮状态（开始/继续/暂停/取消）根据任务进度智能切换，操作更符合直觉。
- **反爬虫与稳定性增强**:
  - **全方位文本反混淆**: 升级 `decode_text` 算法，全面覆盖书名、作者名及简介内容，彻底解决“乱码”和“缺字”问题（如“穿 越”修复为“穿越”，“怎敌”修复为“怎敌她动人”）。
  - **强制 UTF-8 编码**: 所有网络请求强制指定 UTF-8 编码，杜绝底层字符集解析错误。
  - **标题自动清洗**: 自动去除书名中的多余空格和混淆字符，确保文件命名规范。
- **界面交互优化**:
  - **选项整合**: 将“保存格式”选择移至下载确认弹窗中，与章节范围、分章设置统一管理，主界面更简洁。
  - **风控提示**: 在下载界面显著位置增加反爬策略提示，透明化单线程限制原因。
- **智能风控对抗系统**: 
  - 全面升级验证码检测逻辑，从源头识别 WAF 拦截页面。
  - 新增**中断恢复机制**：单本/批量下载遇到验证码时自动暂停，支持用户手动验证后无缝断点续传。
- **自定义浏览器导航**: 
  - 彻底重写浏览器历史记录管理堆栈，接管默认导航逻辑。
  - 解决 SPA (单页应用) 路由切换导致的后退按钮失效/变灰问题，提供丝般顺滑的浏览体验。
- **书籍简介自动归档**: 
  - 无论单本还是批量下载，现在都会自动抓取并保存书籍简介。
  - **分章模式**：自动生成 `000_简介.txt/md` 独立文件，方便管理。
  - **整本/EPUB模式**：简介将作为元数据或首章置顶写入，阅读体验更完整。
- **任务控制增强**:
  - 全新上线 **暂停 / 继续 / 停止** 控制面板，让您随时掌控下载进度，应对突发状况。
  - 新增 **下载间隔自定义** 功能：
    - **随机模式 (默认)**: 模拟人类阅读行为，自动使用随机延迟 (0.5s - 1.5s)，降低风控风险。
    - **自定义模式**: 允许用户指定固定间隔 (0.1s - 60s)。*注意：间隔过短极易触发验证码。*

### 🏗️ 代码重构与优化
- **架构解耦**: 
  - 将庞大的 `main.py` 拆分为 `workers.py` (后台任务)、`ui_components.py` (界面组件) 和 `main.py` (主逻辑)，显著提升代码可维护性。
- **策略模式**: 
  - 重构下载核心，引入 `BookFormatter` 策略模式，统一管理 TXT/MD/EPUB 等不同格式的生成逻辑，消除重复代码，便于未来扩展新格式。

### 🐛 问题修复
- 修复了验证码页面被误判为 "VIP章节锁定" 或 "内容为空" 的解析错误。
- 修复了浏览器导航按钮状态（灰色/亮起）与实际页面历史记录不同步的 Bug。
- 修复了部分网络环境下页面自动跳转至手机版 (Mobile) 导致解析失效的问题，新增自动强制切回 PC 版的保护逻辑。
