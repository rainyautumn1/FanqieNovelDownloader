# 番茄小说内容下载器 (Fanqie Novel Downloader)

## 简介
这是一个基于 Python (PySide6) 开发的高级番茄小说内容下载工具。它集成了内置浏览器，支持用户直接浏览番茄小说网，登录 SVIP 账号以获取完整内容，并提供灵活的单本与批量下载功能。

**⚠️ 重要免责声明**
1. **仅供学习研究**: 本工具仅供个人学习 Python 网络爬虫技术、GUI 开发及研究使用。
2. **版权声明**: 请尊重小说作者及平台的版权。**严禁**使用本工具进行任何形式的商业盈利、非法传播或侵犯知识产权的行为。
3. **责任自负**: 使用本工具产生的任何法律后果由使用者自行承担。

---

## 📅 更新日志 (2025-12-20)

### ✨ 新增功能
- **智能风控对抗系统**: 
  - 全面升级验证码检测逻辑，从源头识别 WAF 拦截页面。
  - 新增**中断恢复机制**：单本/批量下载遇到验证码时自动暂停，支持用户手动验证后无缝断点续传。
- **自定义浏览器导航**: 
  - 彻底重写浏览器历史记录管理堆栈，接管默认导航逻辑。
  - 解决 SPA (单页应用) 路由切换导致的后退按钮失效/变灰问题，提供丝般顺滑的浏览体验。
- **书籍简介自动归档**: 
  - 无论单本还是批量下载，现在都会自动抓取并保存书籍简介。
  - **分章模式**：自动生成 `000_简介.txt/md` 独立文件，方便管理。
  - **整本/EPUB模式**：简介将作为元数据或首章置顶写入，阅读体验更完整。
- **任务控制增强**:
  - 全新上线 **暂停 / 继续 / 停止** 控制面板，让您随时掌控下载进度，应对突发状况。
  - 新增 **下载间隔自定义** 功能：
    - **随机模式 (默认)**: 模拟人类阅读行为，自动使用随机延迟 (0.5s - 1.5s)，降低风控风险。
    - **自定义模式**: 允许用户指定固定间隔 (0.1s - 60s)。*注意：间隔过短极易触发验证码。*

### 🏗️ 代码重构与优化
- **架构解耦**: 
  - 将庞大的 `main.py` 拆分为 `workers.py` (后台任务)、`ui_components.py` (界面组件) 和 `main.py` (主逻辑)，显著提升代码可维护性。
- **策略模式**: 
  - 重构下载核心，引入 `BookFormatter` 策略模式，统一管理 TXT/MD/EPUB 等不同格式的生成逻辑，消除重复代码，便于未来扩展新格式。

### 🐛 问题修复
- 修复了验证码页面被误判为 "VIP章节锁定" 或 "内容为空" 的解析错误。
- 修复了浏览器导航按钮状态（灰色/亮起）与实际页面历史记录不同步的 Bug。
- 修复了部分网络环境下页面自动跳转至手机版 (Mobile) 导致解析失效的问题，新增自动强制切回 PC 版的保护逻辑。

---

## 核心功能

### 1. 📖 内置浏览器与账号互通
- **内置 Chromium 内核浏览器**: 直接在软件内浏览番茄小说官网，无需手动复制粘贴 URL。
- **SVIP 登录支持**: 支持在内置浏览器中登录您的 SVIP 账号。软件会自动同步 Cookie，从而**解锁并下载 SVIP 专属加密章节**。
- **持久化登录**: 新增浏览器数据持久化存储功能，软件重启后**自动保持登录状态**，无需重复扫码。

### 2. ⚡ 智能单本下载
当您浏览至某本书的**目录页**时，软件会自动检测并激活下载按钮：
- **自定义章节选择**:
  - 下载全本。
  - 仅下载前 N 章。
  - 自定义章节范围 (如: 10-50)。
- **文件输出选项**:
  - **合并模式**: 所有章节保存为一个 TXT/EPUB 文件。
  - **拆分模式**: 每一章保存为一个单独的 TXT/MD 文件，并自动归档至书名文件夹。
- **格式支持**: TXT (纯文本), EPUB (电子书), MD (Markdown)。

### 3. 📦 榜单批量下载
当您浏览至**排行榜**或**分类书库**页面（如“男频-新书榜-科幻末世”）时，软件会激活批量下载功能：
- **一键批量**: 支持下载当前榜单页面的前 N 本热门书籍。
- **试读控制**: 可设置每本书仅下载前 X 章（例如仅下载前 10 章预览）。
- **文件管理**:
  - **分章保存**: 新增批量分章下载选项。勾选后，每本书会自动创建一个以书名命名的独立文件夹，章节文件单独存放。
  - **智能归档**: 自动根据榜单层级创建存储目录，分类清晰。
  - 示例路径: `downloads\男频\新书榜\科幻末世\书名\001_第一章.txt` (开启分章模式)

### 4. 🛡️ 核心技术特性
- **字符反混淆 (Anti-Obfuscation)**: 内置特定算法，自动还原被网站混淆的字体字符。
- **多线程处理**: 界面操作与下载任务分离，下载过程中界面不卡顿。
- **实时反馈**: 底部状态栏和日志窗口实时显示当前的下载进度、速度及错误信息。

---

## 技术栈
- **语言**: Python 3.8
- **GUI 框架**: PySide6 (Qt WebEngine)
- **网络请求**: Requests
- **HTML 解析**: BeautifulSoup4, lxml
- **电子书生成**: EbookLib

---

## 使用指南

### 1. 环境准备
确保已安装 Python 3.8+ 版本。
安装项目依赖：
```bash
pip install -r requirements.txt
```

### 2. 启动程序
直接运行启动脚本或 Python 主程序：
```bash
# Windows 用户推荐直接运行
run.bat

# 或手动运行
python main.py
```

### 3. 操作流程

#### A. 下载单本小说
1. 在软件内置浏览器中，点击想看的书，进入**书籍目录页**（网址通常包含 `/page/`）。
2. 右下角 **"下载此书"** 按钮变亮。
3. 点击按钮，在弹出的对话框中选择：
  - 下载范围（全部/自定义）。
  - 是否拆分章节文件。
  - 目标格式 (TXT/EPUB/MD)。
4. 确认后开始下载。

#### B. 批量下载榜单
1. 在内置浏览器中点击 **"排行榜"** 或 **"书库"**。
2. 选择具体的分类（例如：男频 -> 新书榜 -> 玄幻）。
3. 右下角 **"批量下载"** 按钮变亮。
4. 点击按钮，设置：
  - **Top N**: 下载榜单前多少本书。
  - **章节限制**: 每本书下载多少章 (0 为全本)。
  - **分章保存**: 勾选后，将为每本书创建独立文件夹并保存分章文件。
5. 点击开始，程序将自动按 `频道\榜单\分类` 的结构保存文件。

---

## 常见问题
- **下载内容不全？**
  - 请尝试在内置浏览器中登录您的番茄小说账号（特别是 SVIP 账号），软件会自动获取权限。
- **登录状态丢失？**
  - 最新版本已修复此问题。软件会自动在 `browser_data` 目录存储登录凭证，请勿随意删除该文件夹。
- **浏览器无法跳转新标签页？**
  - 已做特殊处理，所有链接均会在当前窗口打开，方便操作。
- **批量下载的文件夹名称？**
  - 系统会自动去除 "官网"、"·" 等冗余字符，只保留核心分类名。
- **没有PYTHON环境？**
  - 查询百度或者bilibili有各种安装教程
- **有没有不用安装Python环境的运行办法？**
  - 你猜build.bat是用来干嘛的，但是这个也需要在有python环境的电脑中运行，运行后会生成dist文件夹，将文件夹里面的所有内容压缩打包分发给其他用户，其他用户解压后就可在没有Python环境的情况下直接运行.exe文件
- **为什么我不直接打包.exe文件？**
  - PySide6的库包太大了
- **为什么出现验证码弹窗？**
  - 这是番茄的反爬策略。**最新版本已解决此问题**：
  - 当程序检测到验证码时，会自动暂停下载任务并弹出提示。
  - 您只需在右侧内置浏览器中完成滑块或点击验证。
  - 验证成功后，点击确定或重新开始下载即可。无需重启软件。
  
---

## 许可证

本项目基于 [MIT License](LICENSE) 开源。

